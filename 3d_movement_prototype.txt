--@name 3d movement prototype
--@author Lil'Tugboat
--@server

prop.setPropClean(false)
prop.setPropUndo(true)

local structure = chip():getAllConstrained()
local chair = nil
local camera = nil
local eyepod = nil


for _, ent in pairs(structure) do
    print(ent)
    if ent:getClass() == "prop_vehicle_prisoner_pod" then
        chair = ent
    elseif ent:getClass() == "gmod_wire_cameracontroller" then
        camera = ent
    elseif ent:getClass() == "gmod_wire_eyepod" then
        eyepod = ent
    end
end

if chair == nil then
    chair = prop.createSent(chip():getPos() + Vector(0,0,50), Angle(), "Seat_Airboat", false)
    constraint.nocollide(chip(), chair)
end

if camera == nil then
    camera = prop.createSent(chip():getPos() + Vector(0,10,0), Angle(),  "gmod_wire_cameracontroller", 1, {
        AllowZoom = false,
        AutoMove = false,
        AutoUnclip = false,
        AutoUnclip_IgnoreWater = false,
        DrawParent = true,
        DrawPlayer = true,
        FreeMove = false,
        LocalMove = false,
        Model = "models/sprops/cuboids/height06/size_1/cube_6x6x6.mdl",
        ParentLocal = false,
    })
    constraint.nocollide(camera, chip())
end


if eyepod == nil then
    eyepod = prop.createSent(chip():getPos() + Vector(10,0,0), Angle(), "gmod_wire_eyepod", true, {
        ClampX = 0,
        ClampXMax = 0,
        ClampXMin = 0,
        ClampY = 0,
        ClampYMax = 0,
        ClampYMin = 0,
        DefaultToZero = 1,
        Model = "models/jaanus/wiretool/wiretool_siren.mdl",
        ShowRateOfChange = 1,
    })
    constraint.nocollide(eyepod, chip())
end


local eyelink = wire.getWirelink(eyepod)
local camLink = wire.getWirelink(camera)

    
--[[
eyepod
-- out
1    =    X
2    =    wirelink
3    =    Y
4    =    XY


--in
1    =    Enable
2    =    SetPitch
3    =    SetYaw
4    =    SetViewAngle
5    =    UnfreezePitch
6    =    UnfreezeYaw


cam
in
1    =    Activated
2    =    Direction
3    =    Angle
4    =    Position
5    =    Distance
6    =    UnRoll
7    =    Parent
8    =    FilterEntities
9    =    FLIR
10    =    FOV

out
1    =    wirelink
2    =    On
3    =    HitPos
4    =    CamPos
5    =    CamDir
6    =    CamAng
7    =    Trace
]]



local offsetVector = chair:getUp()
local offsetAngle = 90

camLink.Position = chair:getPos() - chair:getForward() * 25
camLink.Parent = chair

hook.add("think", "thing", function() 
    local driver = chair:getDriver()
    if driver and driver:isValid() and chair then
        eyelink.Enable = 1
        camLink.Activated = 1
        camLink.Parent = chair
        camLink.Position = chair:getPos() + chair:getForward() * 25
        camLink.Angle = chair:getAngles()

        chair:setFrozen(false)
        
        
        local roll = 0
        rollSpeed = 3
        if chair:getDriver():keyDown(IN_KEY.MOVERIGHT) then
            roll = roll - rollSpeed
        end
        if chair:getDriver():keyDown(IN_KEY.MOVELEFT) then
            roll = roll + rollSpeed
        end
        
        local camAng = chair:getAngles()
        
        camAng = camAng:rotateAroundAxis(chair:getUp(), -eyelink.X)
        camAng = camAng:rotateAroundAxis(camAng:getForward(), eyelink.Y)
        camAng = camAng:rotateAroundAxis(camAng:getRight(), roll)
        local localRot = Vector(eyelink.Y, -eyelink.X, roll)
        rotation = localToWorld(localRot, Angle(), Vector(), chair:getAngles())
        
        --chair:setAngles(camAng)
        chair:applyTorque(rotation - chair:getAngleVelocity() * 0.1)
        
        local speed = 1
        if chair:getDriver():keyDown(IN_KEY.SPEED) then
            speed = 5
        end
        
        
        local forward = 0
        forwardSpeed = 60 * speed
        
        if chair:getDriver():keyDown(IN_KEY.FORWARD) then
            forward = forward + forwardSpeed
        end
        if chair:getDriver():keyDown(IN_KEY.BACK) then
            forward = forward - forwardSpeed
        end
        --chair:applyForceCenter(chair:getForward() * forward)
        chair:setPos(chip():getPos() + Vector(0,0,50))
        
    else
        --chair:setFrozen(true)        
        eyelink.Enable = 0
        camLink.Activated = 0
    end

end)
